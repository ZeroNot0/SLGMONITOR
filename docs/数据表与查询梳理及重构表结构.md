# SLG Monitor 3.0 — 数据表与查询梳理及重构表结构

本文档梳理当前系统使用的**所有数据表（文件）**、**所有查询方式**，以及迁移到 MySQL 后的**重构表结构**与 API 对应关系。

---

## 一、当前使用的所有「表」（数据源）

当前系统没有使用 MySQL，数据全部以**文件**形式存在。按用途分为以下几类。

### 1. 前端展示用 JSON（只读，供页面拉取）

| 逻辑表名 | 存储路径 | 结构说明 | 产出脚本 |
|----------|----------|----------|----------|
| **weeks_index** | `frontend/data/weeks_index.json` | `{ "2025": ["1201-1207", ...], "2026": [...], "data_range": { "start", "end" } }` | `frontend/build_weeks_index.py` |
| **formatted**（公司维度大盘） | `frontend/data/{年}/{周}_formatted.json` | `{ "headers": [...], "rows": [[...], ...] }`，列如：公司归属、产品归属、Unified ID、当周周安装、周流水等 | `frontend/convert_excel_with_format.py`（从 output 监测表 Excel 转） |
| **product_strategy_old** | `frontend/data/{年}/{周}/product_strategy_old.json` | `{ "headers": [...], "rows": [...] }`，产品维度爆量旧产品+地区获量 | `frontend/convert_final_join_to_json.py`（从 final_join Excel 转） |
| **product_strategy_new** | `frontend/data/{年}/{周}/product_strategy_new.json` | 同上，爆量新产品 | 同上 |
| **creative_products** | `frontend/data/{年}/{周}/creative_products.json` | `{ "week_tag", "strategy_old": [{ folder, app_id, product_name, display }], "strategy_new": [...] }` | `frontend/build_creative_products_index.py` |
| **metrics_total**（产品总表） | `frontend/data/{年}/{周}/metrics_total.json` | `{ "headers": [...], "rows": [...] }`，含 Unified Name、Unified ID 等，行数多（需分页/搜索） | `frontend/convert_metrics_to_json.py`（从 intermediate 转） |
| **metrics_rank** | `frontend/data/metrics_rank.json` 或 `frontend/data/{年}/{周}/metrics_rank.json` | `{ "unified_id": { "rankInstall", "rankRevenue" }, ... }`，产品赛道排名 | `frontend/build_metrics_rank.py`（当前前端产品详情页排名由 metrics_total 现场计算，未直接 fetch 此文件） |
| **new_products**（上线新游） | `frontend/data/new_products.json` | `{ "headers": [...], "rows": [...] }` | `frontend/convert_newproducts_to_json.py`（从 newproducts/*.xlsx 转） |
| **product_theme_style_mapping** | `frontend/data/product_theme_style_mapping.json` | `{ "byUnifiedId": { "id": { "题材", "画风" } }, "byProductName": {...} }` | `frontend/convert_product_mapping_to_json.py`（从 mapping/产品归属.xlsx 转） |

### 2. 底表（Excel → 通过 API 转成 JSON 返回）

| 逻辑表名 | 存储路径 | 说明 |
|----------|----------|------|
| **product_mapping**（产品归属表） | `mapping/产品归属.xlsx` | 产品名、Unified ID、产品归属、题材、画风、发行商、公司归属 |
| **company_mapping**（公司归属表） | `mapping/公司归属.xlsx` | 发行商 ↔ 公司归属 |
| **theme_label**（题材标签表） | `labels/题材标签表.xlsx` | 数据底表-题材标签 |
| **gameplay_label**（玩法标签表） | `labels/玩法标签表.xlsx` | 数据底表-玩法标签 |
| **art_style_label**（画风标签表） | `labels/画风标签表.xlsx` | 数据底表-画风标签 |

### 3. 流水线中间/产出（脚本读写，非直接给前端）

| 逻辑表/目录 | 路径 | 说明 |
|-------------|------|------|
| raw_csv | `raw_csv/{年}/{周}/*.csv` | 原始 CSV，步骤 1 输入 |
| merged_deduplicated | `intermediate/{年}/{周}/merged_deduplicated.xlsx` | step1 产出 |
| mapped_total | `intermediate/{年}/{周}/mapped_total.xlsx` | step2 产出（依赖 mapping 三张 Excel） |
| metrics_total（中间） | `intermediate/{年}/{周}/metrics_total.xlsx` | step3 产出，并转成 frontend/data 下 JSON |
| pivot_table | `intermediate/{年}/{周}/pivot_table.xlsx` | step4 产出 |
| 数据监测表 | `output/{年}/{周}_SLG数据监测表.xlsx` | step5 产出，并转成 formatted.json |
| target | `target/{年}/{周}/strategy_target/*.xlsx`, `non_strategy_target/*.xlsx` | 目标产品表，步骤 2 产出 |
| final_join | `final_join/{年}/{周}/*.xlsx` | 目标产品+地区数据，供转 product_strategy_*.json |
| advertisements | `advertisements/{年}/{周}/{产品类型}/{产品目录}/json/*.json` | 广告创意 JSON，前端按路径拼接请求 |
| newproducts | `newproducts/*.xlsx` | 新产品监测表，转 new_products.json |
| 流水系数 | `mapping/流水系数.xlsx` | step2 使用 |

### 4. 登录与权限

| 逻辑表名 | 存储路径 | 说明 |
|----------|----------|------|
| **auth_users** | `deploy/auth_users.json` | `{ "users": [ { "username", "salt", "hash", "role", "status" } ] }` |
| sessions | 内存 `AUTH_SESSIONS` | session_id → { username, role }，无持久化 |

---

## 二、当前所有查询（前端 + 后端 API）

### 2.1 前端直接请求的静态 JSON（或服务端注入）

| 查询用途 | 请求方式 | 路径/参数 | 返回形状 |
|----------|----------|------------|----------|
| 侧栏年/周列表 + 数据时间范围 | 注入 或 GET | `window.__WEEKS_INDEX__` 或 `GET /frontend/data/weeks_index.json` | `{ "2025": [...], "2026": [...], "data_range": {...} }` |
| 题材/画风映射 | 注入 或 GET | `window.__PRODUCT_THEME_STYLE_MAPPING__` 或 `GET /frontend/data/product_theme_style_mapping.json` | `{ byUnifiedId, byProductName }` |
| 公司维度大盘表 | GET | `GET /frontend/data/{year}/{week}_formatted.json` | `{ headers, rows }` |
| 产品维度爆量表（旧/新） | GET | `GET /frontend/data/{year}/{week}/product_strategy_old.json`、`product_strategy_new.json` | `{ headers, rows }` |
| 素材维度产品列表 | GET | `GET /frontend/data/{year}/{week}/creative_products.json` | `{ week_tag, strategy_old, strategy_new }` |
| 上线新游表 | GET | `GET /frontend/data/new_products.json` | `{ headers, rows }` |
| 产品总表（分页+搜索） | GET | `GET /api/basetable/metrics_total?year=&week=&limit=&q=` | `{ headers, rows, total }` |
| 产品总表-产品名与 Unified ID（单周） | GET | `GET /api/basetable/metrics_total_product_names?year=&week=` | `{ productNames, nameToUnifiedId }` |
| 产品总表-产品名与 Unified ID（全周） | GET | `GET /api/basetable/metrics_total_product_names_all` | `{ weeks: [{ year, week, productNames, nameToUnifiedId }] }` |
| 数据底表（5 张） | GET | `GET /api/basetable?name=product_mapping|company_mapping|theme_label|gameplay_label|art_style_label` | `{ headers, rows }` |
| 多周 formatted（组合分析等） | GET | `GET /frontend/data/{year}/{week}_formatted.json` 多次 | 同公司维度大盘 |
| 多周 metrics_total（趋势等） | GET | `GET /frontend/data/{year}/{week}/metrics_total.json` 多次 | `{ headers, rows }` |
| 广告创意明细 | GET | `GET /advertisements/{年}/{周}/{产品类型}/{产品目录}/json/{app_id}_{region}.json` | 各产品各地区的创意 JSON |

### 2.2 后端 API（写操作或需鉴权）

| 查询/操作 | 方法 | 路径 | 说明 |
|-----------|------|------|------|
| 登录态检查 | GET | `/api/auth/check` | 返回 `{ ok, username, role }` |
| 登录 | POST | `/api/auth/login` | Body: `{ username, password }` |
| 登出 | POST | `/api/auth/logout` | 清 session |
| 注册 | POST | `/api/auth/register` | Body: `{ username, password }` |
| 待审批用户列表 | GET | `/api/auth/pending_users` | 需 super_admin |
| 审批通过 | POST | `/api/auth/approve` | Body: `{ username }`，需 super_admin |
| 下载数据监测表 | GET | `/api/maintenance/download?year=&week=` | 返回 Excel 文件流 |
| 数据维护-第一步 | POST | `/api/maintenance/phase1` | 上传 CSV，执行流水线 1 + 前端更新 |
| 数据维护-2.1 步 | POST | `/api/maintenance/phase2_1` | 拉取地区数据 + 前端更新 |
| 数据维护-2.2 步 | POST | `/api/maintenance/phase2_2` | 拉取创意数据 + 前端更新 |
| 归属表更新 | POST | `/api/maintenance/mapping_update` | 上传 Excel，更新 mapping + 生成 product_theme_style_mapping.json |
| 新产品监测表更新 | POST | `/api/maintenance/newproducts_update` | 上传 Excel，写 newproducts/ + 生成 new_products.json |
| 追加到产品归属表 | POST | `/api/maintenance/add_to_product_mapping` | Body: `{ products: [...] }`，写 mapping 产品/公司归属 Excel |
| 视频代理 | GET | `/video-proxy?url=...` | 代理指定 CDN 视频 |

---

## 三、重构后的 MySQL 表结构

以下为迁移到云上后的**建议表结构**。前端展示与底表查询统一改为：**后端从 MySQL 读/写，前端仅通过 API 拉取**；流水线脚本执行完成后**同步写入 MySQL**（或先写文件再 sync 入 DB）。

### 3.1 配置与周索引

```sql
-- 全局配置（键值，如周索引、data_range）
CREATE TABLE app_config (
  config_key   VARCHAR(64) PRIMARY KEY COMMENT '如 weeks_index, data_range',
  config_value JSON NOT NULL COMMENT 'JSON 体',
  updated_at   DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
-- 使用：config_key = 'weeks_index' 存整份 weeks_index.json 的 JSON；
--      或拆成 year_weeks 表 + data_range 行，按需选一。
```

**可选拆分方案（便于按年/周查）：**

```sql
-- 按年周的索引（可选，与 app_config 二选一或并存）
CREATE TABLE year_weeks (
  year      SMALLINT UNSIGNED NOT NULL,
  week_tag  VARCHAR(16) NOT NULL COMMENT '如 0119-0125',
  PRIMARY KEY (year, week_tag)
);

-- 若 data_range 单独存
INSERT INTO app_config (config_key, config_value) VALUES
('data_range', '{"start":"2025-12-01","end":"2026-01-25"}');
```

### 3.2 公司维度 / 产品维度 / 素材索引（按年周存 JSON）

```sql
-- 公司维度大盘（formatted）
CREATE TABLE formatted_data (
  year       SMALLINT UNSIGNED NOT NULL,
  week_tag   VARCHAR(16) NOT NULL,
  payload    JSON NOT NULL COMMENT '{"headers":[...],"rows":[...]}',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (year, week_tag)
);

-- 产品维度爆量表（旧/新各一条）
CREATE TABLE product_strategy (
  year          SMALLINT UNSIGNED NOT NULL,
  week_tag      VARCHAR(16) NOT NULL,
  strategy_type ENUM('old','new') NOT NULL COMMENT 'old=爆量旧产品, new=爆量新产品',
  payload       JSON NOT NULL COMMENT '{"headers":[...],"rows":[...]}',
  updated_at    DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (year, week_tag, strategy_type)
);

-- 素材维度产品索引（creative_products）
CREATE TABLE creative_products (
  year       SMALLINT UNSIGNED NOT NULL,
  week_tag   VARCHAR(16) NOT NULL,
  payload    JSON NOT NULL COMMENT '{"week_tag","strategy_old",[...],"strategy_new",[...]}',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (year, week_tag)
);

-- 产品总表（metrics_total，行多，可分页/搜索在应用层做）
CREATE TABLE metrics_total (
  year       SMALLINT UNSIGNED NOT NULL,
  week_tag   VARCHAR(16) NOT NULL,
  payload    JSON NOT NULL COMMENT '{"headers":[...],"rows":[...]}',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (year, week_tag)
);

-- 产品赛道排名（可选，当前前端可从 metrics_total 现场算）
CREATE TABLE metrics_rank (
  id         INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  payload    JSON NOT NULL COMMENT '{"unified_id":{"rankInstall","rankRevenue"},...}',
  scope      VARCHAR(32) DEFAULT 'global' COMMENT 'global 或 year_week',
  year       SMALLINT UNSIGNED NULL,
  week_tag   VARCHAR(16) NULL,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY (scope, year, week_tag)
);
```

### 3.3 全局单份数据（新游、题材画风映射）

```sql
-- 上线新游表（全局一份）
CREATE TABLE new_products (
  id         TINYINT UNSIGNED PRIMARY KEY DEFAULT 1,
  payload    JSON NOT NULL COMMENT '{"headers":[...],"rows":[...]}',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  CHECK (id = 1)
);

-- 题材/画风映射（全局一份）
CREATE TABLE product_theme_style_mapping (
  id         TINYINT UNSIGNED PRIMARY KEY DEFAULT 1,
  payload    JSON NOT NULL COMMENT '{"byUnifiedId":{...},"byProductName":{...}}',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  CHECK (id = 1)
);
```

### 3.4 数据底表（5 张，名称对应现有 API name）

```sql
CREATE TABLE basetable (
  name       VARCHAR(32) PRIMARY KEY COMMENT 'product_mapping|company_mapping|theme_label|gameplay_label|art_style_label',
  headers    JSON NOT NULL COMMENT '["列名1",...]',
  rows       JSON NOT NULL COMMENT '[[...],...]',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 3.5 用户与会话（替代 auth_users.json + 内存 session）

```sql
CREATE TABLE users (
  id            INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  username      VARCHAR(64) NOT NULL UNIQUE,
  salt          VARCHAR(64) NOT NULL,
  password_hash VARCHAR(128) NOT NULL,
  role          VARCHAR(32) NOT NULL DEFAULT 'user' COMMENT 'user|super_admin',
  status        VARCHAR(32) NOT NULL DEFAULT 'pending' COMMENT 'pending|approved',
  created_at    DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at    DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE sessions (
  session_id   VARCHAR(64) PRIMARY KEY,
  user_id      INT UNSIGNED NOT NULL,
  expires_at   DATETIME NOT NULL,
  created_at   DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

### 3.6 广告创意（可选：是否入库）

广告创意当前为 `advertisements/{年}/{周}/{产品类型}/{产品目录}/json/{app_id}_{region}.json`，前端按 URL 拼接请求。重构时可选择：

- **方案 A**：仍用文件/对象存储，URL 不变，仅其它数据入 MySQL；
- **方案 B**：创意元数据或内容入库，提供 `GET /api/data/creative_unit?year=&week=&...` 等接口返回 JSON。

若不改前端请求路径，可暂不建创意表，仅把「周+产品列表」从 `creative_products` 表读出即可。

---

## 四、重构前后对照：表 ↔ 查询 ↔ API

| 当前数据源 | 当前查询方式 | 重构后表 | 重构后 API（建议） |
|------------|--------------|----------|--------------------|
| weeks_index.json | 注入 / GET 静态 | app_config(key=weeks_index) 或 year_weeks + app_config(data_range) | GET /api/data/weeks_index |
| product_theme_style_mapping.json | 注入 / GET 静态 | product_theme_style_mapping | GET /api/data/product_theme_style_mapping |
| {年}/{周}_formatted.json | GET 静态 | formatted_data | GET /api/data/formatted?year=&week= |
| {年}/{周}/product_strategy_old.json | GET 静态 | product_strategy(type=old) | GET /api/data/product_strategy?year=&week=&type=old |
| {年}/{周}/product_strategy_new.json | GET 静态 | product_strategy(type=new) | GET /api/data/product_strategy?year=&week=&type=new |
| {年}/{周}/creative_products.json | GET 静态 | creative_products | GET /api/data/creative_products?year=&week= |
| {年}/{周}/metrics_total.json | GET 静态 / api 分页搜索 | metrics_total | GET /api/data/metrics_total?year=&week=&limit=&q= |
| metrics_total 衍生 productNames/nameToUnifiedId | /api/basetable/metrics_total_product_names* | metrics_total（应用层解析） | GET /api/data/metrics_total_product_names?year=&week= ，GET /api/data/metrics_total_product_names_all |
| new_products.json | GET 静态 | new_products | GET /api/data/new_products |
| mapping/*.xlsx, labels/*.xlsx | GET /api/basetable?name= | basetable | GET /api/basetable?name=...（从 basetable 表读） |
| auth_users.json | 登录/注册/审批逻辑 | users | 同上，POST/GET /api/auth/* |
| 内存 AUTH_SESSIONS | Cookie 校验 | sessions | 同上 |

---

## 五、小结

- **当前表**：均为文件（JSON + Excel），包括前端用 9 类 JSON、5 张底表 Excel、1 个 auth 文件及若干流水线中间/产出文件。
- **当前查询**：前端静态 GET + 服务端注入 + 后端 API（basetable 分页/搜索、auth、maintenance、download、video-proxy）。
- **重构后**：上述展示与底表数据落入 MySQL 对应表；查询统一经后端「查询 MySQL + 调用脚本」完成；前端仅调用 API，样式与功能保持不变。  
如需，可再补一份「建表语句汇总」或「迁移脚本（现有 JSON/Excel → MySQL）」的单独文档。
