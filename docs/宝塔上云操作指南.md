# SLG Monitor 3.0 — 宝塔上云操作指南

适用于已在腾讯云上使用 **宝塔面板**、网站根目录为 `/www/wwwroot` 的服务器（如你的 `1.12.48.183`）。

---

## 一、本地：打包项目

在 **项目根目录**（`SLG Monitor 3.0`）下执行：

```bash
cd "/Users/codfz1/Desktop/Tuyoo Internship/SLG Monitor 3.0"
bash deploy/pack.sh
```

会生成 `SLG-Monitor-YYYYMMDD-HHMM.zip`，默认**不排除**任何业务文件（含 `raw_csv`、`countiesdata`、`advertisements` 等）。若数据量很大，可先只打包代码与必要数据，再在服务器上单独上传大数据目录。

**可选：只打包代码 + 必要目录（不含大体积数据）**

若希望 zip 更小、上传更快，可手动排除再打包，例如：

```bash
zip -r SLG-Monitor-light.zip . \
  -x "*.git*" \
  -x "raw_csv/*" \
  -x "advertisements/*" \
  -x "countiesdata/*" \
  -x "intermediate/*" \
  -x "request/*"
```

之后把 `mapping/`、`frontend/data/`、`output/`、`target/`、`final_join/` 等按需单独上传到服务器对应位置。

---

## 二、上传到服务器

### 方式 1：宝塔「文件」上传

1. 宝塔 → **文件** → 进入 `/www/wwwroot/`。
2. 若没有 `slgmonitor` 目录，点 **新建目录**，命名为 `slgmonitor`。
3. 进入 `slgmonitor`，点 **上传**，选择本地的 `SLG-Monitor-*.zip` 上传。
4. 上传完成后，选中该 zip → **解压**（解压到当前目录即可）。
5. 若 zip 内是「带一层项目根目录」的，把解压出来的子目录里的**所有内容**移动到 `/www/wwwroot/slgmonitor/`，保证该目录下直接有 `server/start_server.py`、`frontend/`、`mapping/` 等。

### 方式 2：本机 SCP（推荐，大文件更稳）

```bash
# 上传 zip
scp "/Users/codfz1/Desktop/Tuyoo Internship/SLG Monitor 3.0/SLG-Monitor-"*.zip root@1.12.48.183:/www/wwwroot/slgmonitor/

# SSH 登录服务器后解压
ssh root@1.12.48.183
cd /www/wwwroot/slgmonitor
unzip -o SLG-Monitor-*.zip
# 若解压后多了一层目录，把内容移出来，例如：
# mv SLG\ Monitor\ 3.0/* . && rmdir "SLG Monitor 3.0" 2>/dev/null; true
```

确保最终目录结构类似：

```
/www/wwwroot/slgmonitor/
├── server/start_server.py
├── pipeline/run_full_pipeline.py
├── requirements.txt
├── frontend/
├── mapping/
├── backend/
├── deploy/
└── ...
```

---

## 三、服务器：安装依赖并启动

SSH 登录服务器后执行。

### 1. 安装 Python3 与 pip（若未装）

```bash
# 宝塔/腾讯云 Ubuntu 一般已有，可先检查
python3 --version
pip3 --version

# 若没有（以 Ubuntu 为例）：
# sudo apt update && sudo apt install -y python3 python3-pip python3-venv
```

### 2. 安装项目依赖

```bash
cd /www/wwwroot/slgmonitor
pip3 install -r requirements.txt
# 或使用虚拟环境（推荐）：
# python3 -m venv venv && source venv/bin/activate && pip install -r requirements.txt
```

### 3. 测试运行

```bash
cd /www/wwwroot/slgmonitor
python3 server/start_server.py --port 8000
```

浏览器访问：`http://1.12.48.183:8000/frontend/`，能打开则说明服务正常。然后 `Ctrl+C` 停止。

### 4. 使用 systemd 开机自启（推荐）

项目里已提供适配宝塔路径的 unit 文件：

```bash
sudo cp /www/wwwroot/slgmonitor/deploy/slg-monitor.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable slg-monitor
sudo systemctl start slg-monitor
sudo systemctl status slg-monitor
```

若使用**虚拟环境**，需先改 unit 中的启动命令，例如：

```bash
sudo nano /etc/systemd/system/slg-monitor.service
# 将 ExecStart 改为类似：
# ExecStart=/www/wwwroot/slgmonitor/venv/bin/python server/start_server.py --port 8000
```

常用命令：

- 查看日志：`sudo journalctl -u slg-monitor -f`
- 重启：`sudo systemctl restart slg-monitor`

---

## 四、宝塔网站与 Nginx（你已有配置可沿用）

你当前 Nginx 已配置为：

- 网站根目录：`/www/wwwroot/slgmonitor`
- `/frontend/` 由 Nginx 直出（静态加速）
- `/api/` 反代到 `http://127.0.0.1:8000`
- 已开启 gzip、HTTPS（1.12.48.183）

因此只要：

1. 在宝塔「网站」里，该站点**根目录**指向 `/www/wwwroot/slgmonitor`（已指向则无需改）。
2. 确保 **安全组/防火墙** 放行 **80、443**（若直接访问 8000 测试，再放行 8000）。
3. 访问：`https://你的域名/frontend/` 或 `https://1.12.48.183/frontend/`（视你是否绑域名）。

无需再单独「添加反向代理」：现有 `nginx-slgmonitor-full.conf` 已包含 `/api/` 反代到 8000。

---

## 五、可选：使用 MySQL

若本地用 `start_with_mysql.sh` 且希望云上也用 MySQL（用户、权限等存库）：

1. 在宝塔安装 **MySQL**，并创建数据库（如 `slg_monitor`）。
2. 若项目有 SQL 初始化脚本，在服务器执行一次，例如：
   ```bash
   mysql -u root -p slg_monitor < /www/wwwroot/slgmonitor/backend/db/schema.sql
   ```
3. 启动服务前设置环境变量（可写在 systemd 的 `Environment=` 或 `/www/wwwroot/slgmonitor/.env` 中，由 `server/start_server.py` 读取），例如：
   - `USE_MYSQL=1`
   - `MYSQL_HOST=127.0.0.1`
   - `MYSQL_PORT=3306`
   - `MYSQL_USER=root`
   - `MYSQL_PASSWORD=你的密码`
   - `MYSQL_DATABASE=slg_monitor`

若暂时不用 MySQL，不设置即可，服务会以「无数据库」模式运行。

---

## 六、迁移检查清单

- [ ] 本机已执行 `deploy/pack.sh`（或自定义 zip），并上传到 `/www/wwwroot/slgmonitor/` 且解压到位。
- [ ] 服务器已安装 `python3`、`pip3`，并执行 `pip3 install -r requirements.txt`。
- [ ] `mapping/`、`frontend/data/`（及需要的 `raw_csv`、`output` 等）已在服务器上存在且路径正确。
- [ ] `python3 server/start_server.py --port 8000` 能正常启动，且 `http://IP:8000/frontend/` 可访问。
- [ ] 已配置并启用 `slg-monitor.service`，`systemctl status slg-monitor` 为 active。
- [ ] 宝塔网站根目录为 `/www/wwwroot/slgmonitor`，通过 `https://域名或IP/frontend/` 能打开页面，且登录、数据维护等 `/api/` 请求正常。
- [ ] （可选）若使用 MySQL，已建库、导入 schema，并配置好环境变量。

---

## 七、常见问题

**上传 CSV 报 413 或超时**  
Nginx 已设 `client_max_body_size 100M`；若仍报错，在宝塔该站点的 Nginx 配置里确认该指令存在，并适当增大或调整 `proxy_read_timeout`。

**流水线 2.1/2.2 调外部 API 失败**  
检查服务器出网、以及 Sensor Tower 等是否有 IP 白名单，需在对方控制台放行云服务器公网 IP。

**访问很慢**  
当前 Nginx 已为 `/frontend/` 直出静态并开启 gzip；若仍慢，可检查服务器配置（如升配）、地域与访问者距离，以及 `frontend/data/*.json` 是否过大（可考虑按周或按需加载）。

按以上步骤完成后，项目即可在宝塔 + 腾讯云上稳定运行；后续更新只需重新打包、上传覆盖并重启 `slg-monitor` 服务即可。
