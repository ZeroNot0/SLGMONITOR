# 功能一：只制作数据监测表 + 获得目标产品

## 1. 制作数据监测表（已有流程）

| 步骤 | 脚本 | 输入 | 输出 |
|------|------|------|------|
| STEP 1 | pipeline/steps/step1_merge_clean.py | raw_csv/{年}/{周}/ 下各品类 CSV | intermediate/{年}/{周}/merged_deduplicated.xlsx |
| STEP 2 | pipeline/steps/step2_mapping.py | merged + mapping(产品归属、公司归属、流水系数) | intermediate/{年}/{周}/mapped_total.xlsx |
| STEP 3 | pipeline/steps/step3_metrics.py | mapped_total + 流水系数 | intermediate/{年}/{周}/metrics_total.xlsx |
| STEP 4 | pipeline/steps/step4_pivot.py | metrics_total | intermediate/{年}/{周}/pivot_table.xlsx |
| STEP 5 | pipeline/steps/step5_final_report.py | pivot_table（删除条件①、周安装/流水变动、样式） | output/{年}/{周}_SLG数据监测表.xlsx |
| STEP 5.5 | pipeline/steps/step5_5_fix_arrow_color.py | 上表 | 同文件，仅修正箭头颜色 |

- **删除条件①**：当周/上周周安装均 < 400 且 当周/上周周流水均 < 20000 的行删除。
- **样式**：小安装高流水标红删除线、箭头红/绿；**整行标黄**与找目标产品标准一致：仅对**目标产品**（策略目标 + 非策略目标，即 target 表产出）所在行标黄，汇总行保持浅蓝。前端大盘表格的 formatted JSON 由 `frontend/convert_excel_with_format.py` 生成时会读取 `target/{年}/{周}/` 下 4 张目标表，按「产品归属」是否在目标产品集合内重写标黄。

## 2. 获得目标产品（策略 / 非策略）

目标表输出目录：`target/{年}/{周}/strategy_target/` 与 `target/{年}/{周}/non_strategy_target/`。

### 2.1 策略目标产品（strategy_target）

- **规则**：**产品归属在产品归属表中**，且 **当周周安装 ≥ 1000**。
- **做法**：在 mapping/产品归属.xlsx 中出现的「产品归属」构成策略产品名单；数据监测表中，**产品归属** 在该名单内且 **当周周安装 ≥ 1000** 的行，即为策略目标产品。
- **输出**：
  - `target/{年}/{周}/strategy_target/target_strategy_old.xlsx`（爆量旧产品）
  - `target/{年}/{周}/strategy_target/target_strategy_new.xlsx`（爆量新产品）
- **old / new 划分**：按「第三方记录最早上线时间」与截止日期 **2025-01-01** 区分旧产品 / 新产品。

### 2.2 非策略目标产品（non_strategy_target）

- **规则**：**通过 P50 + 周安装量大于 20% 确定**。
- **做法**：
  1. 从数据监测表中筛出**非策略**产品（产品归属不在策略名单内）。
  2. 在该非策略子集中：
     - **P50**：当周周安装的中位数；
     - **周安装量大于 20%**：周安装变动（PoP 环比）> 20%。
  3. 筛选条件：**当周周安装 ≥ P50** 且 **周安装变动 > 20%** 的行，即为非策略目标产品。
- **输出**：
  - `target/{年}/{周}/non_strategy_target/target_non_strategy_old.xlsx`
  - `target/{年}/{周}/non_strategy_target/target_non_strategy_new.xlsx`
- **old / new**：同上，按「第三方记录最早上线时间」与截止日期 **2025-01-01** 区分。

## 3. 功能一整体流程（run_full_pipeline 对应部分）

```
raw_csv → step1 → step2 → step3 → step4 → step5 → step5_5 → output/{年}/{周}_SLG数据监测表.xlsx
                                    ↓
                            pivot_table.xlsx（或 output 表）
                                    ↓
                    + mapping/产品归属.xlsx（含策略/非策略标识）
                    + mapping/上线时间.xlsx（可选，用于 old/new）
                                    ↓
                    generate_target → target/{年}/{周}/strategy_target/
                                    → target/{年}/{周}/non_strategy_target/
```

## 4. 依赖与配置

- **产品归属表**：mapping/产品归属.xlsx，需能区分「策略」产品（例如一列「类型」= 策略，或仅策略品类在表中）。
- **上线时间**（old/new）：mapping/上线时间.xlsx 或使用「第三方记录最早上线时间」+ 固定截止日期。
