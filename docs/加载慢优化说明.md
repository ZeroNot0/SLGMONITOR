# SLG Monitor — 加载慢优化说明

数据有但加载很慢时，按下面顺序排查和优化。

---

## 一、优先用 Nginx（80/443）访问，不要直连 8000

- **推荐**：用 **http://你的域名/frontend/** 或 **http://1.12.48.183/frontend/**（走 80/443）。
- **不推荐**：用 **http://1.12.48.183:8000/frontend/**（直连 Python）。

原因：80/443 由 Nginx 直接提供静态和 `/frontend/data/*.json`，并开启 **gzip 压缩**；8000 是 Python 单进程，不压缩，大 JSON 会慢很多。

---

## 二、在宝塔里加强 Nginx gzip（已写好配置）

项目里 `deploy/nginx-slgmonitor-full.conf` 已加上更强的 gzip 配置，你只需把**同一段**同步到宝塔里的站点配置即可。

1. 宝塔 **「网站」** → 选你的站点（如 1.12.48.183）→ **「设置」** → **「配置文件」**（或「Nginx 配置」）。
2. 找到原来的：
   ```nginx
   gzip on;
   gzip_types text/plain text/css application/json application/javascript;
   gzip_min_length 1024;
   ```
3. 替换为（与项目里一致）：
   ```nginx
   gzip on;
   gzip_vary on;
   gzip_proxied any;
   gzip_comp_level 5;
   gzip_buffers 16 8k;
   gzip_min_length 512;
   gzip_types text/plain text/css application/json application/javascript application/x-javascript;
   ```
4. **保存** → 在网站设置里点 **「重载配置」** 或 **「服务」→「Nginx」→「重载配置」**。

这样大 JSON 会压缩得更好，传输体积更小，加载会快不少。

---

## 三、确认 Nginx 直出的路径和实际项目一致

Nginx 里写的是 **`/www/wwwroot/slgmonitor`**，你部署的目录若是 **`/www/wwwroot/slg-monitor`**（带横杠），需要改一致。

1. 在宝塔 **「文件」** 里看项目真实路径（是 `slgmonitor` 还是 `slg-monitor`）。
2. 在 **「网站」→ 该站点 → 「配置文件」** 里，把：
   - `location ^~ /frontend/` 的 `alias`
   - `location ^~ /frontend/data/` 的 `alias`
   都改成实际路径，例如：
   ```nginx
   alias /www/wwwroot/slg-monitor/frontend/;
   alias /www/wwwroot/slg-monitor/frontend/data/;
   ```
3. 保存并 **重载 Nginx**。

路径错了会导致 404 或走到 Python 8000，变慢。

---

## 四、仍慢时可做的检查

1. **看是否真的走 Nginx**  
   浏览器 F12 → **Network**，刷新页面，看请求的 URL：
   - 是 **http://域名/frontend/...** 或 **http://IP/frontend/...**（无 :8000）→ 走 Nginx，正常。
   - 是 **http://IP:8000/...** → 仍走 Python，请改用 80/443 访问。

2. **看大文件是否被压缩**  
   Network 里点开一个大的 `*.json`（如 `*_formatted.json`），看 Response Headers 里是否有 **Content-Encoding: gzip**。有则说明 gzip 生效。

3. **首屏只加载一周**  
   左侧选「年/周」后，会拉该周的 `formatted.json`、`product_strategy_old/new.json` 等，单周数据量仍大时首屏会慢一次，后续同周会走缓存（Cache-Control 已设 3600 秒）。

---

## 五、小结

| 操作 | 作用 |
|------|------|
| 用 80/443 访问，不用 :8000 | 走 Nginx，gzip + 静态直出，明显变快 |
| 按上面加强 gzip 并重载 Nginx | 大 JSON 体积更小，传输更快 |
| 确认 alias 路径 = 实际项目路径 | 避免 404 或误走 Python |

按顺序做完一、二、三后，再试一次加载速度；若仍慢，把访问地址（是否带 :8000）和 F12 里最慢的请求名发出来，可以再针对性优化。
