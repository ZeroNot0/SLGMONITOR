# SLG Monitor 系统功能与目标

## 一、系统定位与目标

**SLG Monitor** 是一套基于 Sensor Tower（ST）数据的**竞对数据监测**系统，用于：

1. **制作数据监测表**：从原始 CSV/数据生成「SLG 数据监测表」，包含公司/产品、周安装、周流水、周变动等，并产出**目标产品**（策略目标 + 非策略目标）。
2. **获取目标产品的分地区数据与广告创意数据**：通过 **ST API** 拉取目标产品的**分地区下载/收入数据**和**广告创意数据**，并按周、按产品类型落盘。
3. **一键执行完整流程**：通过运行统一入口脚本，按用户选择的**步骤**和**时间段**，依次完成「数据监测表 → 目标产品 → 拉地区数据 → 拉广告数据」等环节。

**用户侧目标**（通过运行脚本实现）：

| 目标 | 说明 | 当前状态 |
|------|------|----------|
| **1. 一键制作数据监测表** | 指定时间段（如 2026-0119-0125），一键跑通 step1→step5_5，产出 `output/{年}/{周}_SLG数据监测表.xlsx`，并产出目标产品表到 `target/` | ✅ 已实现（run_full_pipeline --steps 1,2） |
| **2. 通过 ST API 获取目标产品分地区/广告创意数据** | **request 只针对我们产出的目标产品进行请求**：请求对象来自 step 2 产出的 target 表（strategy_target / non_strategy_target），不是任意列表。基于该目标产品列表调 ST API，拉取分地区数据、广告创意数据，写入 `request/country_data/`、`advertisements/{年}/{周}/` 等 | ⚠️ 脚本骨架已有，需配置真实 API，且从 target 表读取目标产品列表再请求 |
| **3. 一键执行整个流程** | 一条命令完成：制作数据监测表 → 获得目标产品 → 拉取地区数据 → 拉取广告数据 | ⚠️ 步骤 1、2 已接入；步骤 3、4 预留，待 API 与目标产品列表对接后接入 |

---

## 二、当前系统功能拆解

### 1. 一键制作数据监测表（步骤 1）

- **入口**：`python pipeline/run_full_pipeline.py --date 2026-0119-0125 --steps 1`
- **流程**：  
  raw_csv → **step1** 合并去重 → **step2** 映射（产品归属、公司归属、流水系数）→ **step3** 指标 → **step4** 透视 → **step5** 最终报告（删除条件①、周安装/流水变动、样式）→ **step5_5** 箭头颜色
- **产出**：
  - `output/{年}/{周}_SLG数据监测表.xlsx`（数据监测表）
  - `intermediate/{年}/{周}/` 下中间表（merged、mapped、metrics、pivot）

### 2. 获得目标产品（步骤 2）

- **入口**：`python pipeline/run_full_pipeline.py --date 2026-0119-0125 --steps 2`（依赖步骤 1 产出的数据监测表）
- **规则**：
  - **策略目标**：仅通过 **mapping/产品归属.xlsx** 确定，表中出现的产品归属即策略目标。
  - **非策略目标**：非策略产品中，**当周周安装 ≥ P50（中位数）** 且 **周安装变动 > 20%** 的行。
- **产出**：  
  `target/{年}/{周}/strategy_target/`（target_strategy_old.xlsx、target_strategy_new.xlsx）  
  `target/{年}/{周}/non_strategy_target/`（target_non_strategy_old.xlsx、target_non_strategy_new.xlsx）

### 3. 通过 ST API 获取目标产品分地区 / 广告创意数据（步骤 3、4，目标能力）

- **重要**：**request 是根据我们产出的目标产品进行请求的**。请求对象 = step 2 产出的 target 表（`target/{年}/{周}/strategy_target/`、`non_strategy_target/` 下的 xlsx），不是用户手填或任意 app 列表。pipeline 执行步骤 3、4 时应从 target 表读取「目标产品列表」（产品归属 / app_id），再调用 fetch_country_data、fetch_ad_creatives。
- **分地区数据**（步骤 3 预留）：
  - **脚本**：`request/fetch_country_data.py`（依赖 `request/api_request.py` 的 token 与请求封装）
  - **目标**：按**目标产品**（从 target 表解析出的 app_id）调用 ST API，拉取分国家/地区的下载、收入等，写入 `request/country_data/json| xlsx/` 或按需写入其他目录。
- **广告创意数据**（步骤 4 预留）：
  - **脚本**：`request/fetch_ad_creatives.py`
  - **目标**：按**目标产品** + 地区（亚洲 T1、欧美 T1、T2、T3）调用 ST API，拉取广告创意，写入 **advertisements/{年}/{周}/** 对应日期文件夹下（如 `advertisements/2026/0119-0125/strategy_old/{app_id}_{产品名}/json| xlsx/`）。
- **当前缺口**：ST API 的 base URL、接口 path、参数需按实际文档配置；步骤 3、4 需从 target 表读取目标产品列表（产品归属 → app_id 若需映射则通过 mapping 或中间表）再传入 fetch 脚本或由 fetch 脚本支持 `--target_dir target/{年}/{周}` 自动读取。

### 4. 一键执行整个流程（目标）

- **入口**：`python pipeline/run_full_pipeline.py --date 2026-0119-0125 --steps 1,2,3,4`（或默认执行 1,2,3,4）
- **含义**：  
  先执行步骤 1（数据监测表）→ 步骤 2（目标产品）→ 步骤 3（ST API 分地区数据）→ 步骤 4（ST API 广告创意数据），所有产出均对应同一时间段（如 2026-0119-0125）。
- **当前**：步骤 1、2 已实现并可一键执行；步骤 3、4 在 pipeline 中为预留，待 API 与目标产品列表对接后实现真正「一键全流程」。

---

## 三、运行方式小结

- **指定时间段**：`--date 2026-0119-0125` 或 `--year 2026 --week 0119-0125`
- **指定步骤**：`--steps 1,2` 或 `--steps 1,2,3,4`
- **一键制作数据监测表**：`python pipeline/run_full_pipeline.py --date 2026-0119-0125 --steps 1`
- **一键制作数据监测表 + 目标产品**：`python pipeline/run_full_pipeline.py --date 2026-0119-0125 --steps 1,2`（默认即 1,2）
- **一键执行整个流程**（在步骤 3、4 接入后）：`python pipeline/run_full_pipeline.py --date 2026-0119-0125 --steps 1,2,3,4`

---

## 四、final_join 与前端展示

- **final_join** 文件夹存放的是**目标产品表 + 各 T 度市场获量**的结果，**不含广告列**，供**前端展示**或分析使用。
  - 路径：`final_join/{年}/{周}/target_strategy_old_with_ads_all.xlsx`、`target_strategy_new_with_ads_all.xlsx` 等（文件名沿用历史，内容为「目标产品 + 各 T 度获量」）。
  - 内容：target 表（目标产品基础列）+ **各 T 度市场获量列**（亚洲 T1、欧美 T1、T2、T3 的安装、流水等，由 country_data 按 `mapping/市场T度` 汇总得到）。
  - 用途：前端在产品维度读取 final_join 下表时，可同时展示目标产品指标与各 T 度获量；广告创意需从 advertisements 等另行获取。详见 `docs/final_join说明.md`。市场 T 度划分见 `docs/市场T度划分说明.md`。
- 前端 **只读** 后端产出的数据（Excel/JSON），不直接调 API；通过 `python server/start_server.py` 启动后访问 `http://localhost:8000/frontend/`，可按**公司维度、产品维度、素材维度、组合分析**查看数据监测表、目标产品、各 T 度获量及广告创意等（依赖对应目录下已有数据）。

以上即为当前系统的功能与要实现的目标的复述；通过运行脚本可实现：**1. 一键制作数据监测表；2. 通过 ST API 获取目标产品分地区/广告创意数据（脚本已就绪，待 API 与 pipeline 对接）；3. 一键执行整个流程（步骤 1、2 已实现，3、4 待对接后实现）。**
