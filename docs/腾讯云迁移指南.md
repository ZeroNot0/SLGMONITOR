# SLG Monitor 3.0 腾讯云迁移指南

将本站在腾讯云上部署，可按「轻量/云服务器」或「容器」两种方式任选其一。

---

## 一、方案对比

| 方案 | 适用场景 | 成本 | 复杂度 |
|------|----------|------|--------|
| **轻量应用服务器 / CVM** | 内网/小团队、需要维护接口和上传 | 低 | 低 |
| **云托管（Docker）** | 需要弹性、统一用容器 | 中 | 中 |

本站是 **Python HTTP 服务**（`server/start_server.py`），提供静态资源和维护类 API（上传 CSV、跑流水线等），需要**本地磁盘读写**（raw_csv、mapping、output 等）。推荐优先使用 **轻量应用服务器或 CVM**，无需改代码即可迁移。

---

## 二、方案 A：轻量应用服务器 / CVM（推荐）

### 2.1 购买与系统

1. 登录 [腾讯云控制台](https://console.cloud.tencent.com/)。
2. 选择 **轻量应用服务器** 或 **云服务器 CVM**，地域按需选择（如上海、广州）。
3. 镜像选择 **Ubuntu 22.04 LTS**（或 20.04）。
4. 配置建议：1 核 2G 起；若经常跑流水线可 2 核 4G。
5. 安全组/防火墙放行：**TCP 80、443、8000**（8000 为本站默认端口；若用 Nginx 反代可只放 80/443）。

### 2.2 服务器初始化

SSH 登录后执行：

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装 Python 3 与 pip
sudo apt install -y python3 python3-pip python3-venv

# 可选：安装 Nginx（做反向代理、HTTPS）
sudo apt install -y nginx
```

### 2.3 部署项目

```bash
# 创建目录（可按你习惯调整路径）
sudo mkdir -p /opt/slg-monitor
sudo chown $USER:$USER /opt/slg-monitor
cd /opt/slg-monitor

# 方式 1：从本机上传（在本机执行）
# scp -r "/path/to/SLG Monitor 3.0"/* user@<云服务器IP>:/opt/slg-monitor/

# 方式 2：从 Git 克隆（若项目在 Git 仓库）
# git clone <你的仓库地址> .
# 然后上传 data/mapping 等非 Git 目录，或从备份恢复
```

上传或克隆后，确认项目根目录包含：`server/start_server.py`、`pipeline/run_full_pipeline.py`、`frontend/`、`mapping/`、`requirements.txt` 等。

```bash
cd /opt/slg-monitor

# 虚拟环境（推荐）
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# 测试启动
python server/start_server.py --port 8000
# 浏览器访问 http://<云服务器公网IP>:8000/frontend/ 能打开即成功；Ctrl+C 停止
```

### 2.4 使用 systemd 开机自启

已为你准备好 systemd 配置，按下面步骤使用：

```bash
# 1. 复制服务文件（注意路径要与实际一致）
sudo cp /opt/slg-monitor/deploy/slg-monitor.service /etc/systemd/system/

# 2. 若项目不在 /opt/slg-monitor 或不用 www-data 用户，先编辑
sudo nano /etc/systemd/system/slg-monitor.service
# 修改：WorkingDirectory= 项目根目录；ExecStart= 中 venv 与路径；User= 改为运行服务的系统用户（如 ubuntu）
# 若未使用虚拟环境，ExecStart 可改为：/usr/bin/python3 server/start_server.py --port 8000

# 3. 重载并启用
sudo systemctl daemon-reload
sudo systemctl enable slg-monitor
sudo systemctl start slg-monitor
sudo systemctl status slg-monitor
```

常用命令：

- 查看日志：`sudo journalctl -u slg-monitor -f`
- 重启：`sudo systemctl restart slg-monitor`
- 停止：`sudo systemctl stop slg-monitor`

### 2.5 可选：Nginx 反向代理 + HTTPS

若希望用域名 + 80/443 访问（并配置 HTTPS），可在同一台机装 Nginx：

```bash
sudo apt install -y nginx certbot python3-certbot-nginx
```

Nginx 配置示例（`/etc/nginx/sites-available/slg-monitor`）：

```nginx
server {
    listen 80;
    server_name your-domain.com;   # 改成你的域名

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 100M;   # 上传 CSV/Excel 可能较大
    }
}
```

启用并申请证书：

```bash
sudo ln -s /etc/nginx/sites-available/slg-monitor /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx
sudo certbot --nginx -d your-domain.com
```

之后用 **https://your-domain.com/frontend/** 访问即可。

### 2.6 进一步加速：Nginx 直接提供静态资源（推荐）

当前所有请求都经 Python 转发，静态文件（JS/CSS/JSON）也走 Python，容易成为瓶颈。可改为 **Nginx 直接提供 `/frontend/` 下所有静态文件**，只把 **`/api/`** 反代到 Python，效果通常最明显。

- **无需改业务代码**：前端已支持「未注入时请求 weeks_index.json / product_theme_style_mapping.json」，直接用 Nginx 提供静态 `index.html` 即可。
- **Nginx 配置示例**（项目根目录假设为 `/www/wwwroot/slgmonitor`，域名换成你的）：

```nginx
server {
    listen 80;
    server_name slgmonitor.你的域名.com;

    gzip on;
    gzip_types text/plain text/css application/json application/javascript;
    gzip_min_length 1024;

    # 静态：整站 /frontend/ 由 Nginx 从磁盘提供（含 index.html、js、css、data/*.json）
    location /frontend/ {
        alias /www/wwwroot/slgmonitor/frontend/;
        add_header Cache-Control "public, max-age=300";
    }

    # 仅 API 走 Python
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 100M;
    }

    # 视频代理、下载等若仍用 Python，可单独反代或合并到下面
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 100M;
    }
}
```

- **说明**：访问 `http://域名/frontend/` 时，Nginx 直接返回 `frontend/index.html`，不再请求 Python；JS/CSS 和 `frontend/data/*.json` 同样由 Nginx 从磁盘读取并开启 gzip，响应会快很多。登录、数据维护等仍走 `/api/` 到 Python。

---

## 三、方案 B：Docker + 云托管（可选）

项目内已提供 `deploy/Dockerfile`，可在腾讯云 **云托管** 或任意支持 Docker 的环境运行。

### 3.1 本地构建与运行

```bash
cd /path/to/SLG Monitor 3.0
docker build -f deploy/Dockerfile -t slg-monitor:latest .
docker run -d -p 8000:8000 --name slg-monitor slg-monitor:latest
```

访问：http://localhost:8000/frontend/

**注意**：容器内数据随容器删除而丢失。若需持久化，请把 `raw_csv`、`mapping`、`output`、`frontend/data` 等目录用 `-v` 挂载到宿主机或云盘。

### 3.2 腾讯云云托管部署

1. 在 [云托管控制台](https://console.cloud.tencent.com/tcb) 创建服务，选择「从镜像部署」。
2. 镜像来源：先把本地镜像推到 **腾讯云容器镜像仓库**，或使用 CODING / 自建 Git 构建。
3. 端口填 **8000**，并配置公网访问。
4. 若需持久化，为服务挂载「云存储」或「云硬盘」，并把上述目录映射到挂载路径，或在 Dockerfile/启动脚本里把写入目录改到挂载路径。

云托管具体步骤以腾讯云当前文档为准。

---

## 四、迁移检查清单

- [ ] 服务器/容器内已安装 Python 3 与 `requirements.txt` 依赖（pandas、openpyxl）。
- [ ] 端口 8000（或 Nginx 80/443）已在安全组/防火墙放行。
- [ ] `mapping/`、`labels/`、`frontend/data/` 等数据已上传或从备份恢复。
- [ ] 使用 systemd 时，`slg-monitor.service` 中路径、用户已按实际修改。
- [ ] 若使用域名，Nginx 与证书已配置，且前端访问地址与预期一致（如 https://域名/frontend/）。
- [ ] 维护接口（上传 CSV、流水线 2.1/2.2、mapping 更新等）在云上测试通过。

---

## 五、常见问题

**Q：上传 CSV 报 413 或超时？**  
A：调大 Nginx `client_max_body_size`（如 100M），并确认云服务器带宽与超时设置。

**Q：流水线 2.1/2.2 调外部 API 失败？**  
A：检查云服务器出网是否正常、是否有 IP 白名单限制（如 Sensor Tower 等需在控制台放行云机 IP）。

**Q：同网访问文档里的「本机 IP」在云上怎么用？**  
A：云上访问用**公网 IP** 或域名即可，无需同网；若有多台云机内网互访，用内网 IP。

**Q：数据备份建议？**  
A：定期打包 `raw_csv`、`mapping`、`frontend/data`、`output`、`intermediate` 等到对象存储（如 COS）或本机备份目录。

**Q：网站访问很慢、每一步操作都卡？**  
A：  
1. **已做优化**：服务端对 `/frontend/js/`、`/frontend/css/`、`/frontend/data/*.json` 返回 `Cache-Control: public, max-age=300`，浏览器会缓存 5 分钟，切换周或刷新后二次访问会快很多。部署后需**重启 Python 服务**（或重新拉代码并重启）生效。  
2. **Nginx 直接提供静态**（推荐）：见上文 **2.6**，让 Nginx 直接提供整个 `/frontend/`（含 index.html、js、css、data），只把 `/api/` 反代到 Python，并开启 gzip，效果最明显。  
3. **用 Nginx 反代 + gzip**：若暂不改 2.6，至少在宝塔「网站」里为 slgmonitor 配置反向代理到 `http://127.0.0.1:8000`，并开启 **gzip 压缩**，可显著减小 JSON/JS/CSS 体积。  
4. **服务器配置**：若为 1 核 1G 轻量，可考虑升级到 2 核 2G；同时确认地域与访问者距离（同地域更快）。  
5. **大 JSON**：若某周 `*_formatted.json` 或 `product_strategy_*.json` 体积很大（如 >5MB），可考虑后续对接口做分页或按需加载，无需立刻重构。

**Q：要不要换架构、改成纯静态网站？**  
A：  
- **不必大改**：当前已是「前端 SPA + 后端 API」；加速主要靠 **Nginx 直接提供静态**（2.6）和 **浏览器缓存 + gzip**，无需换技术栈。  
- **若要做「纯静态 + CDN」**（可选、后续）：可把 `frontend/` 整目录部署到 **对象存储 + CDN**（如腾讯云 COS+CDN），前端页面和 data/*.json 全部走 CDN；仅登录、数据维护等 `/api/*` 仍走当前服务器。需要：构建/上传静态、前端配置 API 基地址、CDN 与 API 同域或配 CORS。适合访问量再大、希望静态资源全国加速时再做。

完成以上任选一种方案后，站点即可在腾讯云上运行；后续若有新周数据，照常在前端维护页上传或跑流水线即可。
