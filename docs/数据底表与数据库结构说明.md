# 数据底表与数据库结构说明

本文档说明前端「数据底表」页的 7 张表与 MySQL 物理表、文件源的对应关系，以及重构后「表结构以数据底表为准」的约定。

---

## 一、数据底表清单（7 张）

| 序号 | 数据底表名称     | 前端子导航       | 说明 |
|------|------------------|------------------|------|
| 1    | 产品总表         | 产品总表         | 按周展示，列来自 intermediate 的 metrics_total，行数多，支持分页与搜索 |
| 2    | 产品归属表       | 产品归属表       | 产品名、Unified ID、产品归属、题材、画风、发行商、公司归属等 |
| 3    | 公司归属表       | 公司归属表       | 发行商 ↔ 公司归属 |
| 4    | 新产品监测表     | 新产品监测表     | 上线新游来源表，全局一份 |
| 5    | 题材标签表       | 题材标签表       | 题材标签枚举，建议列：序号、标签名、备注 |
| 6    | 玩法标签表       | 玩法标签表       | 玩法标签枚举，建议列：序号、标签名、备注 |
| 7    | 画风标签表       | 画风标签表       | 画风标签枚举，建议列：序号、标签名、备注 |

---

## 二、与 MySQL 物理表对应关系

**表结构以数据底表为准**：前端展示的列与数据来源与下表一致。

| 数据底表       | MySQL 表        | 主键/唯一键           | 备注 |
|----------------|-----------------|------------------------|------|
| 产品总表       | `metrics_total` | (year, week_tag)       | payload 存 JSON：`{"headers":[...],"rows":[...]}` |
| 产品归属表     | `basetable`     | name='product_mapping' | headers/rows 为 JSON，源文件 mapping/产品归属.xlsx |
| 公司归属表     | `basetable`     | name='company_mapping' | 源文件 mapping/公司归属.xlsx |
| 新产品监测表   | `new_products`  | id=1                   | payload 存 JSON：`{"headers":[...],"rows":[...]}` |
| 题材标签表     | `basetable`     | name='theme_label'     | 源文件 labels/题材标签表.xlsx |
| 玩法标签表     | `basetable`     | name='gameplay_label'  | 源文件 labels/玩法标签表.xlsx |
| 画风标签表     | `basetable`     | name='art_style_label' | 源文件 labels/画风标签表.xlsx |

- **basetable** 表结构：`name`（逻辑表名）、`headers`（JSON 数组）、`rows`（JSON 二维数组）、`updated_at`。
- 产品总表、新产品监测表因按周或全局单份、结构已固定，仍用独立表 + payload JSON，与数据底表展示一致。

---

## 三、题材 / 玩法 / 画风三张标签表

### 3.1 源文件位置

- `labels/题材标签表.xlsx`
- `labels/玩法标签表.xlsx`
- `labels/画风标签表.xlsx`

若目录下缺少上述文件，可运行（项目根目录）：

```bash
python scripts/init_label_tables.py
```

会创建带表头（序号、标签名、备注）的空 Excel，且需已安装 `openpyxl`（`pip install openpyxl`）。

### 3.2 建议列结构

| 列名 | 说明     |
|------|----------|
| 序号 | 自增或手填序号 |
| 标签名 | 题材/玩法/画风标签名称 |
| 备注 | 可选说明 |

可根据业务在 Excel 中增列，同步到 MySQL 后会在「数据底表」对应页展示。

### 3.3 同步到 MySQL

- 在「数据维护」上传并更新**产品/公司归属表**时，会调用 `sync_basetable_from_files`，将 mapping/ 与 **labels/** 下 5 张 Excel 同步到 `basetable`。
- 若题材/玩法/画风 Excel 不存在或为空，仍会在 `basetable` 中写入对应 name 的一条记录（空表或默认表头），保证 5 张底表在库中均存在、接口不 404。

---

## 四、其他相关表（非数据底表页）

以下表为系统运行与展示所需，但不属于「数据底表」7 张：

- `app_config`：周索引、data_range 等配置
- `year_weeks`：年+周索引
- `formatted_data`：公司维度大盘
- `product_strategy`：产品维度爆量旧/新
- `creative_products`：素材维度产品索引
- `metrics_rank`：产品赛道排名（可选）
- `product_theme_style_mapping`：题材/画风映射（由产品归属表等衍生，供产品详情页）
- `users`、`sessions`：登录与权限

---

## 五、小结

- **数据底表共 7 张**，与前端「数据底表」页一一对应；**表结构以数据底表为准**，MySQL 仅做存储与查询。
- 其中 5 张（产品归属、公司归属、题材/玩法/画风标签）存于 **basetable**，2 张（产品总表、新产品监测表）为独立表。
- 题材/玩法/画风三张标签表已补全：提供 `labels/` 下 Excel 模板与 `scripts/init_label_tables.py`，同步逻辑保证即使文件缺失也会在库中预留记录。
