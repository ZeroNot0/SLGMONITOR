# SLG Monitor 3.0 — 宝塔面板部署步骤

在宝塔面板（服务器 IP：1.12.48.183，OpenCloudOS 9）上部署本系统的**每一步操作**与**服务器端要做的事**，按顺序执行即可。

---

## 一、部署前准备（建议先做）

### 1. 修改面板默认端口，降低入侵风险

- 左侧菜单点击 **「设置」**。
- 找到 **「面板设置」** 或 **「安全」**，把面板端口从 **8888** 改成其他端口（如 18888），并记下新端口。
- 在腾讯云/防火墙里放行新端口，再用 `http://你的IP:新端口` 登录面板。

### 2. 安装 MySQL（当前 0 个数据库，需要新建）

- 左侧点击 **「软件商店」**。
- 搜索 **「MySQL」**，若未安装则点击 **「安装」**（版本选 5.7 或 8.0 均可）。
- 安装完成后，在 **「数据库」** 里能看到 MySQL 服务。

### 3. 确认 Python 环境

- 软件商店里已有 **「Python 项目管理器 2.5.1」**，若未安装请先安装。
- 安装后可在 **「软件商店」→「已安装」** 或左侧 **「Python」**（若有入口）里找到，用于后面部署 `start_server.py`。

---

## 二、在宝塔里创建 MySQL 数据库（给后续重构用）

若你**先按现有文件版部署**，可跳过本步，等做完「MySQL 重构」后再来创建库。  
若准备**直接上 MySQL 版**，按下面做：

1. 左侧点击 **「数据库」**。
2. 点击 **「添加数据库」**：
   - **数据库名**：如 `slg_monitor`
   - **用户名**：如 `slg_monitor`
   - **密码**：自己设一个强密码，**记下来**（后面代码里要填）
   - **访问权限**：本地服务器
3. 提交后，在数据库列表里会看到 `slg_monitor`，记住：**数据库名、用户名、密码**。
4. （可选）点击该数据库右侧 **「管理」** 进入 phpMyAdmin，后续把 `docs/数据表与查询梳理及重构表结构.md` 里的建表 SQL 粘贴执行，或等项目里提供 `backend/db/schema.sql` 后导入。

---

## 三、把项目代码放到服务器上

### 方式 A：用「文件」上传（适合无 Git）

1. 左侧点击 **「文件」**。
2. 进入要放项目的目录，例如 `/www/wwwroot/` 或 `/opt/`（若没有可新建目录，如 `www/wwwroot/slg-monitor`）。
3. 点击 **「上传」**，选择你本机打包好的项目压缩包（包含 `start_server.py`、`frontend/`、`mapping/`、`run_full_pipeline.py`、`requirements.txt` 等），上传。
4. 上传完成后，在文件列表里**解压**该压缩包，得到项目根目录（例如 `SLG-Monitor-3.0` 或 `slg-monitor`）。
5. 记下**项目根目录的完整路径**，例如：`/www/wwwroot/slg-monitor`。

### 方式 B：用「终端」Git 克隆（适合有仓库）

1. 左侧点击 **「终端」**。
2. 执行（路径按你习惯改）：
   ```bash
   cd /www/wwwroot
   git clone <你的仓库地址> slg-monitor
   cd slg-monitor
   ```
3. 若仓库里没有 `frontend/data`、`mapping` 等目录，需要本机上传这些目录到同一路径补全。
4. 项目根目录即：`/www/wwwroot/slg-monitor`（示例）。

---

## 四、在服务器上安装 Python 依赖并测试运行

1. 左侧点击 **「终端」**。
2. 进入项目根目录（路径换成你上一步的实际路径）：
   ```bash
   cd /www/wwwroot/slg-monitor
   ```
3. 创建虚拟环境并安装依赖（推荐）：
   ```bash
   python3 -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   ```
   若系统没有 `venv`，可：
   ```bash
   pip3 install -r requirements.txt
   ```
4. 测试启动（默认 8000 端口）：
   ```bash
   python start_server.py --port 8000
   ```
   或若用了 venv：`./venv/bin/python start_server.py --port 8000`
5. 在浏览器访问：`http://1.12.48.183:8000/frontend/`，能打开页面即说明服务正常。
6. 在终端里按 **Ctrl+C** 停止，后面用「Python 项目管理器」或「计划任务」来常驻运行。

---

## 五、用「Python 项目管理器」让服务常驻运行

1. 左侧找到并打开 **「Python 项目管理器」**（软件商店里已安装）。
2. 点击 **「添加项目」**（或类似名称）：
   - **项目名称**：如 `SLG Monitor`
   - **项目路径**：选你放代码的目录，例如 `/www/wwwroot/slg-monitor`
   - **启动方式**：选「命令行」或「脚本」
   - **启动命令**：填下面其一（路径按你实际改）：
     - 若用 venv：`/www/wwwroot/slg-monitor/venv/bin/python start_server.py --port 8000`
     - 若未用 venv：`/usr/bin/python3 start_server.py --port 8000`
   - **运行用户**：选能读写项目目录的用户（如 root 或宝塔创建的 www）。
3. 保存后，在项目列表里对该项目执行 **「启动」**。
4. 再次访问 `http://1.12.48.183:8000/frontend/` 确认正常。若 8000 端口未在防火墙放行，需在宝塔 **「安全」** 里放行 8000。

---

## 六、网站配置：让外网通过 80/443 访问（反向代理）

你当前已有 1 个网站，可以**在现有站点上做反向代理**，也可以**新建一个站点**专门给 SLG Monitor。

### 做法一：在现有网站下加反向代理（推荐）

1. 左侧点击 **「网站」**，找到你要用的那个站点，点 **「设置」**。
2. 在左侧选 **「反向代理」**，点击 **「添加反向代理」**：
   - **代理名称**：如 `SLG Monitor API`
   - **目标 URL**：填 `http://127.0.0.1:8000`
   - **发送域名**：留空或填 `$host`
3. **高级** 或 **配置** 里，把以下路径代理到 8000（不同宝塔版本界面略有差异，本质是 Nginx 的 `location`）：
   - 若希望整站都是 SLG：代理 `/` 到 `http://127.0.0.1:8000`
   - 若希望用子路径（如 `http://你的域名/slg/`）：
     - 代理 `/slg/` 到 `http://127.0.0.1:8000/`
4. 保存。访问 `http://你的域名/` 或 `http://你的域名/slg/frontend/` 测试。

### 做法二：新建一个站点

1. **网站** → **添加站点**：
   - 域名：如 `slg.你的域名.com` 或用 IP
   - 根目录：可先随便选，因为实际由反向代理到 8000
2. 在该站点 **设置** → **反向代理** 里，添加代理到 `http://127.0.0.1:8000`（同上）。
3. 若用域名，需在 **「域名」** 或 **「SSL」** 里绑定并（可选）申请证书。

### 重要：放行端口与安全组

- 宝塔 **「安全」** 里放行 **80、443、8000**（若直接访问 8000）。
- 腾讯云控制台 **安全组** 里同样放行 80、443、8000。

---

## 七、计划任务（可选）：定时跑流水线

若需要每周自动跑数据（如 `run_full_pipeline.py`）：

1. 左侧点击 **「计划任务」**。
2. **添加计划任务**：
   - **任务类型**：Shell 脚本
   - **任务名称**：如「SLG 每周数据更新」
   - **执行周期**：选「每周」并选星期几、几点（如每周一 2:00）
   - **脚本内容**（路径按实际改）：
     ```bash
     cd /www/wwwroot/slg-monitor
     source venv/bin/activate
     python run_full_pipeline.py --year 2026 --week 0119-0125
     ```
3. 保存后可点「执行」试跑一次，在「日志」里看是否成功。

---

## 八、服务器端操作清单（小结）

| 步骤 | 在宝塔里做什么 | 说明 |
|------|----------------|------|
| 1 | **设置** → 改面板端口 | 降低 8888 默认端口风险 |
| 2 | **软件商店** → 安装 MySQL | 当前 0 个数据库，需先装 MySQL |
| 3 | **数据库** → 添加数据库 | 库名/用户名/密码记好，重构时用 |
| 4 | **文件** 上传 或 **终端** git clone | 把项目放到如 `/www/wwwroot/slg-monitor` |
| 5 | **终端**：`cd 项目目录` → `python3 -m venv venv` → `source venv/bin/activate` → `pip install -r requirements.txt` | 安装依赖 |
| 6 | **终端**：`python start_server.py --port 8000` | 测试能否访问 8000 |
| 7 | **Python 项目管理器** → 添加项目，启动命令填 `venv/bin/python start_server.py --port 8000` | 常驻运行 |
| 8 | **网站** → 选站点 → **反向代理** → 目标 `http://127.0.0.1:8000` | 用 80/443 访问前端和 API |
| 9 | **安全**：放行 80、443、8000；腾讯云安全组同样放行 | 外网可访问 |
| 10 | **计划任务**（可选）：每周执行 `run_full_pipeline.py` | 定时更新数据 |

---

## 九、若后续完成「MySQL + 后端 API」重构

到时的服务器端额外操作会是：

1. **数据库**：在已有 MySQL 里执行建表 SQL（或导入 `backend/db/schema.sql`），执行一次数据迁移脚本（把现有 JSON/Excel 导入 MySQL）。
2. **环境变量**：在 Python 项目管理器里给项目配置环境变量，例如：
   - `MYSQL_HOST=127.0.0.1`
   - `MYSQL_PORT=3306`
   - `MYSQL_USER=slg_monitor`
   - `MYSQL_PASSWORD=你设的密码`
   - `MYSQL_DATABASE=slg_monitor`
3. **启动命令**：改为启动新后端（如 `flask run` 或 `gunicorn`），不再用 `start_server.py`（或保留静态+新 API 同一入口）。
4. **网站 / 反向代理**：目标改为新后端端口（如 5000 或 8000），无需改域名。

按上述步骤在宝塔里逐项操作即可完成部署；若某一步在你这边的面板里名称不一样，把实际界面发出来可以再按你的界面写一版更贴合的说明。
